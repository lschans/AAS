/*
 * HTTP Server for angular-server-with-sockets
 *
 * Description:  http server
 *-----------------------------------------------------
 * Author: Lars van der Schans
 * Email:  lars@wodanbrothers.com
 *-----------------------------------------------------
 */

// redis port 6379

var http = require('http'),
    config = {},
    log = {},
    socketio;

module.exports = function(server) {
    config = server.config;
    log = server.log,
    socketio = server.httpSocket
    http;

    return {
        server : function(callback) {
            //sticky(function() {
                httpServer = http.createServer(function (request, response) {
                    log.writeLog({domain: 'request', request: request});
                    callback(request, response);
                }).listen(config.global.httpPort);

                log.writeLog({message: 'HTTP Server online', domain: 'server', port: config.global.httpPort});
                if (config.global.verbose === true) console.log('HTTP-Server started on port ' + config.global.httpPort);

                // Some socket test stuff
                var socketServer = socketio.listen(httpServer);
                // Connect the sockets to redis
                socketServer.adapter(server.redis({host: config.global.redisServer, port: config.global.redisPort}));

                socketServer.on('connection', function (socket) {
                    console.log('https socket connected to worker ' + process.pid);
                    socket.on('message', function (msg) {
                        console.log('Message Received: ' + msg);
                        socket.broadcast.emit('message', process.pid + ' - ' + msg);
                    });
                });

                //return httpServer;
            //});
        }
    }
}