/*
 * Module that processes POST for angular-server-with-sockets
 *
 * Description: Module processes POST data and adds it to the request object
 *              request.headers.post will be set by this module
 *-----------------------------------------------------
 * Author: Lars van der Schans
 * Email:  lars@wodanbrothers.com
 *-----------------------------------------------------
 */

var qs = require('querystring');

module.exports = function(config) {
    return {
        getPost : function(request, response) {
            if (request.method == 'POST') {  // Catch POST methods
                var post = '';
                request.on('data', function (data) {
                    post += data;
                    // 1e6 === 1 * Math.pow(10, 6) === 1 * 1000000 ~~~ 1MB
                    if (post.length > 1e6) {
                        // FLOOD ATTACK OR FAULTY CLIENT, NUKE REQUEST
                        request.connection.destroy();
                    }
                });

                request.on('end', function () {
                    request.post = qs.parse(post);
                    // use POST
                    return;
                });
            } else { // Continue normal operation
                request.headers.post = {};
                return;
            }
        }
    }
}