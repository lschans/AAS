/*
 * session manager for angular-server-with-sockets
 *
 * Description:  Session manager for 'angular server with sockets'
 *
 * TODO:
 *      Session set data
 *      Session get data
 *-----------------------------------------------------
 * Author: Lars van der Schans
 * Email:  lars@wodanbrothers.com
 *-----------------------------------------------------
 */

var Fiber = require('fibers'),
    config = {},
    log = {};

module.exports = function(server) {
    config = server.config;
    log = server.log;

    sessions =  {
        setSession : function(request, response, callback) {
            var d = new Date(),
                r = response.randomString(32),
                sessionID = new Buffer(r + d).toString('base64').replace(/\=/g, '');

            Fiber(function() {
                var mongoSync = require("mongo-sync").Server,
                    mongoServer = new mongoSync(config.session.mongoHost),
                    database = mongoServer.db(config.session.database),
                    collection = database.getCollection(config.session.collection),
                    result = collection.update({ "sessionID":sessionID }, { $set: { "sessionID":sessionID, "ip":request.connection.remoteAddress, "dateTime":response.dateCookieString(d), "data":{}}}, {upsert:true});
                    request.session = {};
                    response.setCookie(request, response, ['X-Session-ID', sessionID]);
                    callback(request, response);
            }).run();
        },
        getSession : function(request, response, callback) {
            // Set session code here
            Fiber(function() {
                var mongoSync = require("mongo-sync").Server,
                    mongoServer = new mongoSync(config.session.mongoHost),
                    database = mongoServer.db(config.session.database),
                    collection = database.getCollection(config.session.collection);
                request.session = collection.findOne({"sessionID":request.cookies["X-Session-ID"]});
                console.log({"X-Session-ID":request.cookies["X-Session-ID"]});
                console.log(request.session);
                callback(request, response);
            }).run();

        },
        clearSession : function (request, response, callback) {
            // Clear a session
        },
        initSession : function (request, response, callback) {
            // Initialize session
            request.session = {};
            if(typeof(request.cookies["X-Session-ID"]) !== 'undefined'){
                sessions.getSession(request, response, function(request, response){
                    callback(request, response);
                })
            } else {
                // set session
                console.log('No session, set one');
                sessions.setSession(request,response, function(request, response){
                    callback(request, response);
                })

            }

        }
    }
    return sessions;
}